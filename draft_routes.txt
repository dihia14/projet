

from flask import Flask, request, render_template, session, redirect, url_for, abort 
import bcrypt
import logging
import requests
from routes import * 



from managers.database_manager import UserDatabase
from managers.mail_manager import EmailManager
from managers.ip_manager import IPManager
from managers.password_manager import PasswordManager
from managers.files_manager import FileManager
from managers.filePage_manager import * 
from rules.brute_force_rule import * 
import sqlite3
from ids_alerts_parser import LogParserIdsAlert
from .admin import *
# injections sql => bloque adresse IP 
# emplacement pour afficher les alertes pour l'admin 
# statistiques : nb d'attaques des ≠ types : par jours, minutes, ...
# voire pour ransom ( voir avec le Sftp , ... )
# analyse d'un fichier malveillant .. 
# Sftp, "drive" pour des "chiffré" des files 


#init of the managers 
db_manager = UserDatabase()


#init the IP manager 
ip_manager = IPManager()


#init the mail manager 
mail_manager = EmailManager() ###recheck 

# Initialisation des paramètres globaux pour EmailManager only once (same as db recheck dans in init app )
EmailManager.initialize(
    smtp_server="smtp.gmail.com",
    port=587,
    sender_email="jafjafnora@gmail.com",
    sender_password="luzz vnkb izzm lpps"
)

#password_manager = PasswordManager()

def write_last_ip(client_ip):
    with open("last_ip.txt", "w") as f:
        f.write(f"{client_ip}\n")


def authorize(client_ip): 
    try:
        with open("black_list.txt", "r") as f:
            lst_ip = f.read().strip().splitlines() # retrieve the black ips 
        
        if client_ip in lst_ip:
            return False  # not authorized access 
        else:
            return True  # authorized access 
    
    except FileNotFoundError:
        print("Error.")
        return True



#bloquer ensuite les @ips tentant de faire cela ? 

# Initialise les routes pour notre application flasks 
def register_routes(app):
    
    # route pour afficher la page index.html 
    @app.route('/')
    def index():
        client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
        logging.info(f"Home page loaded from {client_ip}" )
        write_last_ip(client_ip)
        print(f"Current session: {dict(session)}")  

        if not authorize(client_ip) : 
            return "access unauthorized"
        else :
            print("ACCES autorisé ")     
 
 
        loging_msg = request.args.get('loging_msg', '') 
        return render_template('index.html', loging_msg=loging_msg)

    @app.route('/logout')
    def logout():
        session.clear()  
        logging.info("User successfully logged out")
        return render_template('index.html')
      
    # @app.route('/new_password/<username>')
    # def new_password(username):
    #     user_info = db_manager.get_user_infos(username)
    #     # ask for another password to generate 
    #     new_password = PasswordManager.generate_password()
    #     hashed_password = bcrypt.hashpw(new_password.encode('utf-8'), bcrypt.gensalt())

    #     # send it to the user 
    #     email = user_info[2]
    #     mail_manager.send_confirmation_mail_user(username, email, new_password, False)
        
    #     #update the db 
    #     db_manager.update_password_username(username, hashed_password) ##
    #     print(f"NEW password requested for user: {username}")
    #     return render_template('user_settings_page.html', user_info=user_info)  
    
    
      
    # @app.route('/reset_password')
    # def reset_password():
    #     return render_template('index.html')  



    @app.route('/admin/file_page/<username>')
    def admin_file_page(username) : 
        user_info = db_manager.get_user_infos(username)
        user_id = user_info[0]
        
        return file_page(username)
        


    # #@app.route('/admin')
    # @app.route('/admin/<username>')
    # def admin(username):
        
    #     # if 'username' not in session or not session.get('is_admin', False):
    #     #     return redirect(url_for('index', loging_msg="Unauthorized access"))
    
    #     client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
    #     logging.info(f"Admin page accessed by {session['username']} from {client_ip}")
    
    
    #     user_info = db_manager.get_user_infos(username)

    #     client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)

    #     print("in admin", client_ip)


    #     recent_logs = FileManager.get_last_logs()
        

    #     ids_alerts = LogParserIdsAlert.load_last_alerts(last_n=6)
        
        
    #     ip_data = ip_manager.load_ip_data()

    #     # TODO : recheck ici, une autre méthode ? 
    #     if client_ip not in ip_data:
    #         location = ip_manager.get_ip_location(client_ip)
    #         if location:
    #             lat, lon, country, city = location
    #             ip_data[client_ip] = {
    #                 'lat': lat,
    #                 'lon': lon,
    #                 'country': country,
    #                 'city' : city
    #             }
    #             ip_manager.save_ip_data(ip_data)  
                
    #     map_html = ip_manager.generate_map(ip_data)

    #     logging.info(f"Admin page via {client_ip}")

    #     success_message = request.args.get('success')
    #     error_message = request.args.get('error')

    #     return render_template(
    #         'admin.html',
    #         logs=recent_logs,
    #         ids_alerts = ids_alerts,
    #         map_html=map_html,
    #         success_message=success_message,
    #         error_message=error_message,
    #         user_info=user_info
    #     )




    # @app.route('/admin_users_manager')
    # def gestion_users():
    #     # ID , username, hash password, mail, privilèges 
    #     #users = get_users_db()
    #     users = db_manager.get_users()
    #     return render_template('admin_users_manager.html', users=users)  #


   # @app.route('/user_settings_page')
    @app.route('/user_settings_page/<username>')
    def user_settings_page(username):
        # ID , username, hash password, mail, privilèges 
        #user_info = get_user_infos(username)
        user_info = db_manager.get_user_infos(username)
        print(user_info)
        print(f"Current session: {dict(session)}")  

        return render_template('user_settings_page.html', user_info=user_info)  #

    
    @app.route('/delete_user/<int:user_id>', methods=['POST'])
    def delete_user(user_id):
        db_manager.delete_user(user_id)
        return gestion_users()

    @app.route('/add_user', methods=['POST'])
    def add_user_route():
        
        # retireve the data from the form 
        username = request.form.get('username')
        email = request.form.get('email')  
        password = PasswordManager.generate_password()

            
            
        hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
        is_admin = False 
        
        try:
            db_manager.add_user(username, hashed_password, email, is_admin)
            mail_manager.send_confirmation_mail_user(username, email, password, True)
            #return redirect(url_for('admin', success=f"User {username} has been successfully added."))
            return redirect(url_for('admin', username=session['username'], success=f"User {username} has been successfully added."))

        except sqlite3.IntegrityError as e:
            if "UNIQUE constraint failed: users.email" in str(e):
                error_message = "The email is already in use. Please choose another one."
            else:
                error_message = "An error occurred while adding the user."
            #return render_template('admin.html', error=error_message)
            #return redirect(url_for('admin', error=error_message))
            return redirect(url_for('admin', username=session['username'], error=error_message))

        except Exception as e:
            #return render_template('admin.html', error=f"Unexpected error: {str(e)}")
            return redirect(url_for('admin', username=session['username'], error=f"Unexpected error: {str(e)}"))



    
    @app.route('/reset_password', methods=['POST'])
    def reset_password():
        username = request.form.get('username')
        email = request.form.get('email')

        # Vérifier si l'utilisateur existe
        user = db_manager.get_user(username)

        if not user or user[3] != email:  # Vérifier que l'email correspond également
            loging_msg = "Erreur : Utilisateur ou email non trouvé."
            return redirect(url_for('index', loging_msg=loging_msg))

        # Générer un nouveau mot de passe et le hacher
        new_password = PasswordManager.generate_password()
        hashed_password = bcrypt.hashpw(new_password.encode('utf-8'), bcrypt.gensalt())

        # Mettre à jour le mot de passe dans la base de données
        db_manager.update_password_username(username, hashed_password)

        # Envoyer l'email avec le nouveau mot de passe
        mail_manager.send_confirmation_mail_user(username, email, new_password, False)

        # Rediriger vers l'index avec un message de confirmation
        loging_msg = "Un email avec votre nouveau mot de passe a été envoyé."
        return redirect(url_for('index', loging_msg=loging_msg))



        
    @app.route('/login', methods=['POST'])
    def login():
        
        loging_msg = ""
        
        # retrieve the data from the form 
        username = request.form.get('username')
        password = request.form.get('password')
        
        logging.info(f"Login attempt for user: {username}")
        if check_brute_force(username):
            
            logging.error(f"Too many failed attempts for {username}. Please try again later.'")
            loging_msg = "Too many failed attempts. Please try again later."
            #return render_template('index.html')
            return redirect(url_for('index', loging_msg=loging_msg))############

        
        user = db_manager.get_user(username)

        if user:
            hashed_password = user[2] 
            is_admin = user[4]  
            #print("is admin ? ", is_admin)
            if bcrypt.checkpw(password.encode('utf-8'), hashed_password):
                
                # retrieve session data 
                session['username'] = username
                session['is_admin'] = is_admin
                session['user_id'] = user[0]
                session.permanent = True  

            
                if is_admin:
                    logging.info(f"Admin login successful for : {username}")
                    return admin(username)
                else:
                    logging.info(f"User login successful for : {username}")
                    #return admin()  # juste pour le test apres mettre la page adéquate i.e user()
                    return user_settings_page(username)
            else:
                logging.error(f"Invalid password for user : {username}")
                loging_msg = f"Invalid password for : {username}"
                log_failed_attempt(username) #save la tentative de connexion 

                return redirect(url_for('index', loging_msg=loging_msg))

                #return render_template('index.html')
        else:
            logging.warning(f"Attempt to connect with a user not found : {username}")
            loging_msg = f"Attempt to connect with a user not found : {username}"
            return redirect(url_for('index', loging_msg=loging_msg))
            #return render_template('index.html')



    #@app.route('/file_page/<username>')
    @app.route('/user_settings_page/file_page/<username>')
    def file_page(username):
        
        # ID , username, hash password, mail, privilèges 
        user_info = db_manager.get_user_infos(username)
        user_id = user_info[0]
        
        files = list_files(str(user_id))
        print(f"USER INFO : {user_id} , FILES {files}")
        return render_template('file_page.html', files=files, user_id=str(user_id), user_info=user_info)



    @app.route('/uploads', methods=['POST'])
    def upload():
        
        user_id = session['user_id']
        response, status_code = upload_file(request, user_id) 
        if status_code == 200:
            username_ = session['username']
            user_info = db_manager.get_user_infos(username_)
            user_id = user_info[0]

            files = list_files(str(user_id)) 
            response["files"] = files 
        return response, status_code
    
    

    @app.route('/delete_file', methods=['POST'])
    def delete_file_route():
         
        #user_id = request.form.get("user_id")
        user_id = session['user_id']
        username = session['username']

        file_name = request.form.get("file_name")

        response, status_code = delete_file(user_id, file_name)
        files = list_files(user_id)    # a voir apres 
        
        return redirect(url_for('file_page', username=username))


    @app.route('/download/<user_id>/<filename>')
    def download_file(user_id, filename):  
        print("IN DOWNLOAD FILE ")
        user_folder = os.path.join("uploads", user_id)
        file_path = os.path.join(user_folder, filename)

        # envoie du fichier 
        if os.path.exists(file_path):
            return send_from_directory(user_folder, filename, as_attachment=True)
        else:
            abort(404, description="File not found")
            
            
            
            



HOW THE FLASK KEY WAS GENERATED ? 
# api key generated 
# from import secrets
# print(secrets.token_hex(32))  # 64 car 
# print(app.secret_key)
# export FLASK_SECRET_KEY='fa66975909197233d5647efdbb3006931e5f5452ec9385abb49dca1f7c7fee49'